name: Deploy to VPS

# ä»…åœ¨ main åˆ†æ”¯ä¸” CI é€šè¿‡åè‡ªåŠ¨éƒ¨ç½²
on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches:
      - main

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    # åªæœ‰ CI æˆåŠŸæ—¶æ‰éƒ¨ç½²
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to VPS via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT }}
        script: |
          echo "ğŸš€ Starting deployment..."
          
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd /opt/ragenius || exit 1
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          echo "ğŸ“¥ Pulling latest code..."
          git pull origin main
          
          # é‡å¯æœåŠ¡
          echo "ğŸ”„ Restarting services..."
          docker compose down
          docker compose up -d --build
          
          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          echo "â³ Waiting for services to start..."
          sleep 10
          
          # æ£€æŸ¥æœåŠ¡çŠ¶æ€
          echo "ğŸ” Checking service status..."
          docker compose ps
          
          # æµ‹è¯•åç«¯å¥åº·
          curl -f http://localhost:8000/api/health || echo "âš ï¸  Backend health check failed"
          
          # æ¸…ç†æ—§çš„ Docker é•œåƒ
          echo "ğŸ§¹ Cleaning up..."
          docker system prune -f
          
          echo "âœ… Deployment completed!"
          echo "ğŸŒ Visit: https://your-domain.com"

    - name: Deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Deployment successful!"
        else
          echo "âŒ Deployment failed!"
        fi

